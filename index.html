<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outil Calcul ROI & ROAS - BTS Com</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        .main-container {
            background: var(--card-bg);
            width: 100%;
            max-width: 600px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding-bottom: 20px;
        }

        /* ONGLETS */
        .tabs-header { display: flex; background-color: #e2e8f0; border-bottom: 1px solid #cbd5e1; }
        .tab-btn { flex: 1; padding: 1rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; }
        .tab-btn.active { background-color: #fff; color: var(--primary); border-bottom: 3px solid var(--primary); }

        /* CONTENU */
        .tab-content { display: none; padding: 2rem; }
        .tab-content.active { display: block; }
        
        h2 { text-align: center; color: var(--primary); margin-top: 0; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        
        input[type="number"] {
            width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; box-sizing: border-box;
        }
        
        /* RESULTATS ECRAN */
        .results-wrapper { margin-top: 20px; border-top: 2px dashed #cbd5e1; padding-top: 20px; display: none; }
        .result-cards-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .res-card { padding: 15px; border-radius: 10px; text-align: center; color: white; }
        .bg-roas { background-color: #0f172a; }
        .bg-roi { background-color: var(--primary); }
        .res-val { font-size: 1.8rem; font-weight: bold; display: block; }

        /* BOUTONS EXPORT */
        .export-section { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: center; gap: 15px; }
        button.btn-export { padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; display: inline-flex; gap: 8px; background: white; border: 2px solid #ccc; }
        .btn-pdf { color: #D32F2F; border-color: #D32F2F; }
        .btn-excel { color: #1D6F42; border-color: #1D6F42; }

    </style>
</head>
<body>

<div class="main-container">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab('simple', this)">1. Version Simple</button>
        <button class="tab-btn" onclick="openTab('detailed', this)">2. Version D√©taill√©e</button>
    </div>

    <div id="simple" class="tab-content active">
        <h2>Calcul Rapide</h2>
        <div class="input-group">
            <label>1. Chiffre d'Affaires (‚Ç¨)</label>
            <input type="number" id="s_revenue" placeholder="0" oninput="calcSimple()">
        </div>
        <div class="input-group">
            <label>2. Budget M√©dia (‚Ç¨)</label>
            <input type="number" id="s_media" placeholder="0" oninput="calcSimple()">
        </div>
        <div class="input-group">
            <label>3. Autres Co√ªts (‚Ç¨)</label>
            <input type="number" id="s_other" placeholder="0" oninput="calcSimple()">
        </div>
        <div class="results-wrapper" id="s_results">
            <div class="result-cards-container">
                <div class="res-card bg-roas"><span class="res-label">ROAS</span><span class="res-val" id="s_resRoas">0.00</span></div>
                <div class="res-card bg-roi"><span class="res-label">ROI</span><span class="res-val" id="s_resRoi">0%</span></div>
            </div>
            <div style="text-align:center; margin-top:10px; font-weight:bold;">B√©n√©fice : <span id="s_resProfit">0</span> ‚Ç¨</div>
        </div>
    </div>

    <div id="detailed" class="tab-content">
        <h2>Calcul D√©taill√©</h2>
        <div class="input-group">
            <label>Volume x Prix</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="d_vol" placeholder="Qt√©" oninput="calcDetail()">
                <input type="number" id="d_price" placeholder="Prix ‚Ç¨" oninput="calcDetail()">
            </div>
            <div style="text-align:right; font-weight:bold; color:var(--primary); margin-top:5px;">CA : <span id="d_displayRev">0</span> ‚Ç¨</div>
        </div>

        <div class="input-group">
            <label>D√©penses</label>
            <input type="number" id="d_media" placeholder="M√©dia ‚Ç¨" oninput="calcDetail()" style="margin-bottom:5px;">
            <input type="number" id="d_prod" placeholder="Prod ‚Ç¨" oninput="calcDetail()" style="margin-bottom:5px;">
            <input type="number" id="d_fees" placeholder="Honoraires ‚Ç¨" oninput="calcDetail()" style="margin-bottom:5px;">
            <input type="number" id="d_other" placeholder="Autres ‚Ç¨" oninput="calcDetail()">
            <div style="text-align:right; font-weight:bold; color:#ef4444; margin-top:5px;">Co√ªt : <span id="d_displayCost">0</span> ‚Ç¨</div>
        </div>

        <div class="results-wrapper" id="d_results">
            <div class="result-cards-container">
                <div class="res-card bg-roas"><span class="res-label">ROAS</span><span class="res-val" id="d_resRoas">0.00</span></div>
                <div class="res-card bg-roi"><span class="res-label">ROI</span><span class="res-val" id="d_resRoi">0%</span></div>
            </div>
            <div style="text-align:center; margin-top:10px; font-weight:bold;">B√©n√©fice : <span id="d_resProfit">0</span> ‚Ç¨</div>
        </div>
    </div>

    <div class="export-section">
        <button class="btn-export btn-excel" onclick="downloadExcel()">üìó Excel</button>
        <button class="btn-export btn-pdf" onclick="generateReportPDF()">üìÑ PDF</button>
    </div>
</div>

<script>
    // --- ONGLETS ---
    function openTab(name, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(name).style.display = 'block';
        btn.classList.add('active');
    }

    // --- CALCULS (Simple & D√©taill√©) ---
    function calcSimple() {
        const rev = parseFloat(document.getElementById('s_revenue').value) || 0;
        const media = parseFloat(document.getElementById('s_media').value) || 0;
        const other = parseFloat(document.getElementById('s_other').value) || 0;
        updateDisplay('s_', rev, media, media + other);
        document.getElementById('s_results').style.display = 'block';
    }

    function calcDetail() {
        const vol = parseFloat(document.getElementById('d_vol').value) || 0;
        const price = parseFloat(document.getElementById('d_price').value) || 0;
        const rev = vol * price;
        
        const media = parseFloat(document.getElementById('d_media').value) || 0;
        const cost = media + (parseFloat(document.getElementById('d_prod').value)||0) + (parseFloat(document.getElementById('d_fees').value)||0) + (parseFloat(document.getElementById('d_other').value)||0);
        
        document.getElementById('d_displayRev').innerText = rev.toLocaleString('fr-FR');
        document.getElementById('d_displayCost').innerText = cost.toLocaleString('fr-FR');
        
        updateDisplay('d_', rev, media, cost);
        document.getElementById('d_results').style.display = 'block';
    }

    function updateDisplay(prefix, ca, media, totalCost) {
        let roas = media > 0 ? (ca / media) : 0;
        let profit = ca - totalCost;
        let roi = totalCost > 0 ? ((profit / totalCost) * 100) : 0;

        document.getElementById(prefix + 'resRoas').innerText = roas.toFixed(2);
        document.getElementById(prefix + 'resRoi').innerText = roi.toFixed(1) + '%';
        document.getElementById(prefix + 'resProfit').innerText = profit.toLocaleString('fr-FR');
    }

    // --- LE SECRET DU PDF PARFAIT ---
    // On ne capture pas l'√©cran. On construit un rapport HTML propre en m√©moire.
    function generateReportPDF() {
        // 1. D√©tection du mode actif
        const isSimple = document.getElementById('simple').style.display !== 'none';
        
        // 2. R√©cup√©ration des donn√©es selon le mode
        let data = {};
        if (isSimple) {
            data = {
                title: "Calcul Rapide",
                rows: [
                    { label: "Chiffre d'Affaires", val: (document.getElementById('s_revenue').value || 0) + " ‚Ç¨" },
                    { label: "Budget M√©dia", val: (document.getElementById('s_media').value || 0) + " ‚Ç¨" },
                    { label: "Autres Co√ªts", val: (document.getElementById('s_other').value || 0) + " ‚Ç¨" }
                ],
                roas: document.getElementById('s_resRoas').innerText,
                roi: document.getElementById('s_resRoi').innerText,
                profit: document.getElementById('s_resProfit').innerText
            };
        } else {
            // Mode D√©taill√©
            const vol = document.getElementById('d_vol').value || 0;
            const price = document.getElementById('d_price').value || 0;
            data = {
                title: "Calcul D√©taill√©",
                rows: [
                    { label: "Volume de ventes", val: vol },
                    { label: "Panier Moyen", val: price + " ‚Ç¨" },
                    { label: "CA TOTAL", val: document.getElementById('d_displayRev').innerText + " ‚Ç¨", bold: true },
                    { label: "---", val: "" },
                    { label: "Budget M√©dia", val: (document.getElementById('d_media').value || 0) + " ‚Ç¨" },
                    { label: "Production & Frais", val: ((parseFloat(document.getElementById('d_prod').value)||0) + (parseFloat(document.getElementById('d_fees').value)||0)).toLocaleString() + " ‚Ç¨" },
                    { label: "CO√õT TOTAL", val: document.getElementById('d_displayCost').innerText + " ‚Ç¨", bold: true }
                ],
                roas: document.getElementById('d_resRoas').innerText,
                roi: document.getElementById('d_resRoi').innerText,
                profit: document.getElementById('d_resProfit').innerText
            };
        }

        // 3. Construction du HTML "Virtuel" (Style Noir et Blanc pur pour impression)
        // C'est ce HTML que le g√©n√©rateur PDF va "voir"
        const reportContent = `
            <div style="padding: 20px; font-family: Arial, sans-serif; color: #000;">
                <h1 style="text-align:center; color:#2563eb; margin-bottom: 30px;">Rapport de Rentabilit√©</h1>
                <h3 style="border-bottom: 2px solid #000; padding-bottom: 10px;">Mode : ${data.title}</h3>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    ${data.rows.map(row => `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-size: 14px; ${row.bold ? 'font-weight:bold;' : ''}">${row.label}</td>
                            <td style="padding: 12px; font-size: 14px; text-align: right; font-weight: bold;">${row.val}</td>
                        </tr>
                    `).join('')}
                </table>

                <div style="background-color: #f8f9fa; border: 2px solid #000; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; text-align: center;">R√âSULTATS</div>
                    <table style="width: 100%;">
                        <tr>
                            <td style="text-align: center;">
                                <div style="font-size: 12px; text-transform: uppercase;">ROAS</div>
                                <div style="font-size: 24px; font-weight: bold; color: #000;">${data.roas}</div>
                            </td>
                            <td style="text-align: center; border-left: 1px solid #ccc;">
                                <div style="font-size: 12px; text-transform: uppercase;">ROI</div>
                                <div style="font-size: 24px; font-weight: bold; color: #000;">${data.roi}</div>
                            </td>
                            <td style="text-align: center; border-left: 1px solid #ccc;">
                                <div style="font-size: 12px; text-transform: uppercase;">B√©n√©fice</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${parseFloat(data.profit.replace(/\s/g, '')) < 0 ? 'red' : 'green'};">${data.profit} ‚Ç¨</div>
                            </td>
                        </tr>
                    </table>
                </div>
                <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #666;">
                    G√©n√©r√© automatiquement le ${new Date().toLocaleDateString()}
                </div>
            </div>
        `;

        // 4. Cr√©ation d'un √©l√©ment temporaire invisible
        const element = document.createElement('div');
        element.innerHTML = reportContent;
        
        // 5. G√©n√©ration
        const opt = {
            margin:       0.5,
            filename:     'Rapport_ROI.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save();
    }

    // --- EXPORT EXCEL (Inchang√©) ---
    function downloadExcel() {
        const isSimple = document.getElementById('simple').style.display !== 'none';
        let exportData = [];

        if (isSimple) {
            exportData = [
                ["RAPPORT CALCUL RAPIDE"], [" "],
                ["Chiffre d'Affaires", document.getElementById('s_revenue').value],
                ["Budget M√©dia", document.getElementById('s_media').value],
                ["Autres Co√ªts", document.getElementById('s_other').value],
                [" "], ["RESULTATS"],
                ["ROAS", document.getElementById('s_resRoas').innerText],
                ["ROI", document.getElementById('s_resRoi').innerText],
                ["B√©n√©fice", document.getElementById('s_resProfit').innerText]
            ];
        } else {
             exportData = [
                ["RAPPORT CALCUL D√âTAILL√â"], [" "],
                ["Volume", document.getElementById('d_vol').value],
                ["Panier", document.getElementById('d_price').value],
                ["CA TOTAL", document.getElementById('d_displayRev').innerText],
                [" "],
                ["D√©penses M√©dia", document.getElementById('d_media').value],
                ["Autres Frais", ((parseFloat(document.getElementById('d_prod').value)||0) + (parseFloat(document.getElementById('d_fees').value)||0)).toString()],
                ["CO√õT TOTAL", document.getElementById('d_displayCost').innerText],
                [" "], ["RESULTATS"],
                ["ROAS", document.getElementById('d_resRoas').innerText],
                ["ROI", document.getElementById('d_resRoi').innerText],
                ["B√©n√©fice", document.getElementById('d_resProfit').innerText]
            ];
        }
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(exportData);
        XLSX.utils.book_append_sheet(wb, ws, "Rapport");
        XLSX.writeFile(wb, "Rapport_Rentabilite.xlsx");
    }
</script>

</body>
</html>
