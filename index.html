<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outil Calcul ROI & ROAS - BTS Com</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #1e293b;
            --border: #cbd5e1;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
            --pdf-color: #D32F2F;
            --excel-color: #1D6F42;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        .main-container {
            background: var(--card-bg);
            width: 100%;
            max-width: 600px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding-bottom: 20px;
        }

        /* ONGLETS */
        .tabs-header { display: flex; background-color: #e2e8f0; border-bottom: 1px solid #cbd5e1; }
        .tab-btn { flex: 1; padding: 1rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; }
        .tab-btn.active { background-color: #fff; color: var(--primary); border-bottom: 3px solid var(--primary); }

        /* CONTENU */
        .tab-content { display: none; padding: 2rem; }
        .tab-content.active { display: block; }
        
        h2 { text-align: center; color: var(--primary); margin-top: 0; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        .hint { font-size: 0.8rem; color: #64748b; margin-top: 4px; font-style: italic; }
        
        input[type="number"] {
            width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; box-sizing: border-box; text-align: right;
        }
        
        /* GRILLES */
        .revenue-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .operator { font-weight: bold; font-size: 1.2rem; color: #94a3b8; text-align: center; padding-top: 1.5rem; }
        .costs-list { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: grid; gap: 10px; }
        .cost-item { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; align-items: center; font-size: 0.9rem; }
        .media-highlight input { border-color: #93c5fd; background-color: #eff6ff; }

        /* RESULTATS ECRAN */
        .results-wrapper { margin-top: 20px; border-top: 2px dashed #cbd5e1; padding-top: 20px; display: none; }
        .result-cards-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .res-card { padding: 15px; border-radius: 10px; text-align: center; color: white; }
        .bg-roas { background-color: #0f172a; }
        .bg-roi { background-color: var(--primary); }
        .res-val { font-size: 1.8rem; font-weight: bold; display: block; }
        .res-label { font-size: 0.75rem; text-transform: uppercase; opacity: 0.8; }

        .status-msg { margin-top: 1rem; padding: 1rem; border-radius: 8px; text-align: center; font-weight: bold; display: none; }
        .status-profit { background: var(--success-bg); color: var(--success-text); }
        .status-loss { background: var(--danger-bg); color: var(--danger-text); }

        /* BOUTONS EXPORT */
        .export-section { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: center; gap: 15px; }
        button.btn-export { padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; display: inline-flex; gap: 8px; background: white; transition: all 0.2s; }
        .btn-pdf { color: var(--pdf-color); border: 2px solid var(--pdf-color); }
        .btn-pdf:hover { background-color: var(--pdf-color); color: white; }
        .btn-excel { color: var(--excel-color); border: 2px solid var(--excel-color); }
        .btn-excel:hover { background-color: var(--excel-color); color: white; }

    </style>
</head>
<body>

<div class="main-container">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab('simple', this)">1. Version Simple</button>
        <button class="tab-btn" onclick="openTab('detailed', this)">2. Version D√©taill√©e</button>
    </div>

    <div id="simple" class="tab-content active">
        <h2>Calcul Rapide</h2>
        <div class="input-group">
            <label>1. Chiffre d'Affaires (‚Ç¨)</label>
            <input type="number" id="s_revenue" placeholder="0" oninput="calcSimple()">
        </div>
        <div class="input-group">
            <label>2. Budget M√©dia (‚Ç¨)</label>
            <input type="number" id="s_media" placeholder="0" oninput="calcSimple()">
            <div class="hint">Utilis√© pour le ROAS</div>
        </div>
        <div class="input-group">
            <label>3. Autres Co√ªts (‚Ç¨)</label>
            <input type="number" id="s_other" placeholder="0" oninput="calcSimple()">
            <div class="hint">Ajout√© au m√©dia pour le ROI</div>
        </div>
        
        <div class="results-wrapper" id="s_results">
            <div class="result-cards-container">
                <div class="res-card bg-roas"><span class="res-label">ROAS</span><span class="res-val" id="s_resRoas">0.00</span></div>
                <div class="res-card bg-roi" id="s_cardRoi"><span class="res-label">ROI</span><span class="res-val" id="s_resRoi">0%</span></div>
            </div>
            <div class="status-msg" id="s_status"></div>
            <div style="text-align:center; margin-top:10px; font-weight:bold; color:#666;">B√©n√©fice Net : <span id="s_resProfit">0</span> ‚Ç¨</div>
        </div>
    </div>

    <div id="detailed" class="tab-content">
        <h2>Calcul D√©taill√©</h2>
        <div class="input-group">
            <label>Volume x Prix</label>
            <div class="revenue-grid">
                <div><label style="font-size:0.8rem">Qt√©</label><input type="number" id="d_vol" placeholder="0" oninput="calcDetail()"></div>
                <div class="operator">√ó</div>
                <div><label style="font-size:0.8rem">Prix (‚Ç¨)</label><input type="number" id="d_price" placeholder="0" oninput="calcDetail()"></div>
            </div>
            <div style="text-align:right; font-weight:bold; color:var(--primary); margin-top:5px;">CA Total : <span id="d_displayRev">0</span> ‚Ç¨</div>
        </div>

        <div class="input-group">
            <label>Charges (D√©tail)</label>
            <div class="costs-list">
                <div class="cost-item media-highlight"><span>üì¢ Budget M√©dia</span><input type="number" id="d_media" placeholder="0" oninput="calcDetail()"></div>
                <div class="cost-item"><span>üé® Production</span><input type="number" id="d_prod" placeholder="0" oninput="calcDetail()"></div>
                <div class="cost-item"><span>ü§ù Honoraires</span><input type="number" id="d_fees" placeholder="0" oninput="calcDetail()"></div>
                <div class="cost-item"><span>üì¶ Autres</span><input type="number" id="d_other" placeholder="0" oninput="calcDetail()"></div>
            </div>
            <div style="text-align:right; font-weight:bold; color:#ef4444; margin-top:5px;">Co√ªt Total : <span id="d_displayCost">0</span> ‚Ç¨</div>
        </div>

        <div class="results-wrapper" id="d_results">
            <div class="result-cards-container">
                <div class="res-card bg-roas"><span class="res-label">ROAS</span><span class="res-val" id="d_resRoas">0.00</span></div>
                <div class="res-card bg-roi" id="d_cardRoi"><span class="res-label">ROI</span><span class="res-val" id="d_resRoi">0%</span></div>
            </div>
            <div class="status-msg" id="d_status"></div>
            <div style="text-align:center; margin-top:10px; font-weight:bold; color:#666;">B√©n√©fice Net : <span id="d_resProfit">0</span> ‚Ç¨</div>
        </div>
    </div>

    <div class="export-section">
        <button class="btn-export btn-excel" onclick="downloadExcel()">üìó Excel</button>
        <button class="btn-export btn-pdf" onclick="generateReportPDF()">üìÑ PDF</button>
    </div>
</div>

<script>
    // --- ONGLETS ---
    function openTab(name, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(name).style.display = 'block';
        btn.classList.add('active');
    }

    // --- CALCULS ---
    function calcSimple() {
        const rev = parseFloat(document.getElementById('s_revenue').value) || 0;
        const media = parseFloat(document.getElementById('s_media').value) || 0;
        const other = parseFloat(document.getElementById('s_other').value) || 0;
        const totalCost = media + other;
        updateUI('s_', rev, media, totalCost);
        document.getElementById('s_results').style.display = 'block';
    }

    function calcDetail() {
        const vol = parseFloat(document.getElementById('d_vol').value) || 0;
        const price = parseFloat(document.getElementById('d_price').value) || 0;
        const rev = vol * price;
        const media = parseFloat(document.getElementById('d_media').value) || 0;
        const cost = media + (parseFloat(document.getElementById('d_prod').value)||0) + (parseFloat(document.getElementById('d_fees').value)||0) + (parseFloat(document.getElementById('d_other').value)||0);
        
        document.getElementById('d_displayRev').innerText = rev.toLocaleString('fr-FR');
        document.getElementById('d_displayCost').innerText = cost.toLocaleString('fr-FR');
        updateUI('d_', rev, media, cost);
        document.getElementById('d_results').style.display = 'block';
    }

    function updateUI(prefix, revenue, mediaCost, totalCost) {
        let roas = mediaCost > 0 ? (revenue / mediaCost) : 0;
        let profit = revenue - totalCost;
        let roi = totalCost > 0 ? ((profit / totalCost) * 100) : 0;

        document.getElementById(prefix + 'resRoas').innerText = roas.toFixed(2);
        document.getElementById(prefix + 'resRoi').innerText = roi.toFixed(1) + '%';
        document.getElementById(prefix + 'resProfit').innerText = profit.toLocaleString('fr-FR');

        const statusBox = document.getElementById(prefix + 'status');
        const cardRoi = document.getElementById(prefix + 'cardRoi');
        
        if(roi < 0) {
            statusBox.style.display = 'block';
            statusBox.className = 'status-msg status-loss';
            statusBox.innerText = "‚ö†Ô∏è Op√©ration non rentable";
            cardRoi.style.backgroundColor = '#ef4444';
        } else {
            statusBox.style.display = 'block';
            statusBox.className = 'status-msg status-profit';
            statusBox.innerText = "‚úÖ Op√©ration rentable";
            cardRoi.style.backgroundColor = '#2563eb';
        }
    }

    // --- PDF PROPRE (Rapport Virtuel) ---
    function generateReportPDF() {
        const isSimple = document.getElementById('simple').style.display !== 'none';
        let data = {};

        if (isSimple) {
            data = {
                title: "Calcul Rapide",
                rows: [
                    { label: "Chiffre d'Affaires", val: (document.getElementById('s_revenue').value || 0) + " ‚Ç¨" },
                    { label: "Budget M√©dia", val: (document.getElementById('s_media').value || 0) + " ‚Ç¨" },
                    { label: "Autres Co√ªts", val: (document.getElementById('s_other').value || 0) + " ‚Ç¨" }
                ],
                roas: document.getElementById('s_resRoas').innerText,
                roi: document.getElementById('s_resRoi').innerText,
                profit: document.getElementById('s_resProfit').innerText
            };
        } else {
            const vol = document.getElementById('d_vol').value || 0;
            const price = document.getElementById('d_price').value || 0;
            data = {
                title: "Calcul D√©taill√©",
                rows: [
                    { label: "Volume de ventes", val: vol },
                    { label: "Panier Moyen", val: price + " ‚Ç¨" },
                    { label: "CA TOTAL", val: document.getElementById('d_displayRev').innerText + " ‚Ç¨", bold: true },
                    { label: "---", val: "" },
                    { label: "Budget M√©dia", val: (document.getElementById('d_media').value || 0) + " ‚Ç¨" },
                    { label: "Production & Frais", val: ((parseFloat(document.getElementById('d_prod').value)||0) + (parseFloat(document.getElementById('d_fees').value)||0)).toLocaleString() + " ‚Ç¨" },
                    { label: "CO√õT TOTAL", val: document.getElementById('d_displayCost').innerText + " ‚Ç¨", bold: true }
                ],
                roas: document.getElementById('d_resRoas').innerText,
                roi: document.getElementById('d_resRoi').innerText,
                profit: document.getElementById('d_resProfit').innerText
            };
        }

        const reportContent = `
            <div style="padding: 20px; font-family: Arial, sans-serif; color: #000;">
                <h1 style="text-align:center; color:#2563eb; margin-bottom: 30px;">Rapport de Rentabilit√©</h1>
                <h3 style="border-bottom: 2px solid #000; padding-bottom: 10px;">Mode : ${data.title}</h3>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    ${data.rows.map(row => `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-size: 14px; ${row.bold ? 'font-weight:bold;' : ''}">${row.label}</td>
                            <td style="padding: 12px; font-size: 14px; text-align: right; font-weight: bold;">${row.val}</td>
                        </tr>
                    `).join('')}
                </table>
                <div style="background-color: #f8f9fa; border: 2px solid #000; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; text-align: center;">R√âSULTATS</div>
                    <table style="width: 100%;">
                        <tr>
                            <td style="text-align: center;">
                                <div style="font-size: 12px; text-transform: uppercase;">ROAS</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.roas}</div>
                            </td>
                            <td style="text-align: center; border-left: 1px solid #ccc;">
                                <div style="font-size: 12px; text-transform: uppercase;">ROI</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.roi}</div>
                            </td>
                            <td style="text-align: center; border-left: 1px solid #ccc;">
                                <div style="font-size: 12px; text-transform: uppercase;">B√©n√©fice</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${parseFloat(data.profit.replace(/\s/g, '')) < 0 ? 'red' : 'green'};">${data.profit} ‚Ç¨</div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        `;

        const element = document.createElement('div');
        element.innerHTML = reportContent;
        const opt = { margin: 0.5, filename: 'Rapport_ROI.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(element).save();
    }

    // --- EXCEL DYNAMIQUE (AVEC FORMULES) ---
    function downloadExcel() {
        const isSimple = document.getElementById('simple').style.display !== 'none';
        let data = [];
        
        // --- MODE SIMPLE ---
        if (isSimple) {
            // Entr√©es
            const s_rev = parseFloat(document.getElementById('s_revenue').value) || 0;
            const s_media = parseFloat(document.getElementById('s_media').value) || 0;
            const s_other = parseFloat(document.getElementById('s_other').value) || 0;

            data = [
                ["RAPPORT SIMPLE"],
                [""],
                ["Chiffre d'Affaires", { t: 'n', v: s_rev }], // Cell B3
                ["Budget M√©dia", { t: 'n', v: s_media }],     // Cell B4
                ["Autres Co√ªts", { t: 'n', v: s_other }],     // Cell B5
                [""],
                // ROAS = CA / M√©dia
                ["ROAS", { t: 'n', f: "IF(B4>0, B3/B4, 0)" }],
                // ROI = (CA - (M√©dia+Autre)) / (M√©dia+Autre)
                ["ROI", { t: 'n', f: "IF((B4+B5)>0, (B3-(B4+B5))/(B4+B5), 0)" }], 
                // B√©n√©fice = CA - Co√ªt Total
                ["B√©n√©fice Net", { t: 'n', f: "B3-(B4+B5)" }]
            ];
        } 
        // --- MODE D√âTAILL√â ---
        else {
            const d_vol = parseFloat(document.getElementById('d_vol').value) || 0;
            const d_price = parseFloat(document.getElementById('d_price').value) || 0;
            
            const d_media = parseFloat(document.getElementById('d_media').value) || 0;
            const d_prod = parseFloat(document.getElementById('d_prod').value) || 0;
            const d_fees = parseFloat(document.getElementById('d_fees').value) || 0;
            const d_other = parseFloat(document.getElementById('d_other').value) || 0;

            // D√©calage des lignes pour les formules (index 1 = ligne 2 Excel)
            // On √©crit √† partir de la ligne 2.
            
            data = [
                ["RAPPORT D√âTAILL√â"],
                [""],
                ["Volume de Ventes", { t: 'n', v: d_vol }],   // B3
                ["Prix Unitaire", { t: 'n', v: d_price }],    // B4
                ["CA TOTAL", { t: 'n', f: "B3*B4" }],         // B5
                [""],
                ["Budget M√©dia", { t: 'n', v: d_media }],     // B7
                ["Production", { t: 'n', v: d_prod }],        // B8
                ["Honoraires", { t: 'n', v: d_fees }],        // B9
                ["Autres", { t: 'n', v: d_other }],           // B10
                ["CO√õT TOTAL", { t: 'n', f: "SUM(B7:B10)" }], // B11
                [""],
                // ROAS = CA / M√©dia
                ["ROAS", { t: 'n', f: "IF(B7>0, B5/B7, 0)" }],
                // ROI = (CA - TotalCost) / TotalCost
                ["ROI", { t: 'n', f: "IF(B11>0, (B5-B11)/B11, 0)" }],
                // B√©n√©fice
                ["B√©n√©fice Net", { t: 'n', f: "B5-B11" }]
            ];
        }
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Astuce : formater les cellules ROI en pourcentage dans Excel n'est pas possible facilement avec la version "gratuite" de SheetJS
        // Mais les formules fonctionneront parfaitement.
        
        XLSX.utils.book_append_sheet(wb, ws, "Resultats");
        XLSX.writeFile(wb, "Rapport_Rentabilite.xlsx");
    }
</script>

</body>
</html>
